#!/usr/bin/env bash
#
# carpi - helper CLI for the CarPi Audio Ducker

set -euo pipefail

# This will be replaced by install.sh
APP_DIR="__CARPI_APP_DIR__"
SERVICE_NAME="audio-ducker"
LOG_FILE="$APP_DIR/audio-ducker.log"
DEFAULT_PORT="5000"

usage() {
    cat <<EOF
CarPi CLI

Usage:
  carpi status           Show systemd user service status
  carpi restart          Restart the audio-ducker service
  carpi stop             Stop the service
  carpi start            Start the service
  carpi logs [N]         Tail last N log lines (default 100)
  carpi metrics          Show JSON from /api/metrics
  carpi status-json      Show JSON from /api/status
  carpi settings         Show JSON from /api/settings
  carpi health           Run health check script (if installed)
  carpi open-ui          Print URL for web UI
  carpi version          Show app version info from /api/version
  carpi update           Pull latest from Git and rerun install.sh

EOF
}

# Discover UI host (very simple)
ui_host() {
    # Prefer the Pi's LAN IP
    local host
    host=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [ -z "${host:-}" ]; then
        host="localhost"
    fi
    echo "http://$host:${CARPI_PORT:-$DEFAULT_PORT}"
}

# Helper: curl JSON and pretty-print if jq exists
curl_json() {
    local url="$1"
    if command -v curl >/dev/null 2>&1; then
        if command -v jq >/dev/null 2>&1; then
            curl -sS "$url" | jq .
        else
            curl -sS "$url"
        fi
    else
        echo "curl not found; please install curl." >&2
        return 1
    fi
}

cmd="${1:-}"

case "$cmd" in
    status)
        systemctl --user status "$SERVICE_NAME"
        ;;

    restart)
        systemctl --user restart "$SERVICE_NAME"
        systemctl --user status "$SERVICE_NAME" --no-pager --lines=5
        ;;

    stop)
        systemctl --user stop "$SERVICE_NAME"
        ;;

    start)
        systemctl --user start "$SERVICE_NAME"
        systemctl --user status "$SERVICE_NAME" --no-pager --lines=5
        ;;

    logs)
        lines="${2:-100}"
        tail -n "$lines" "$LOG_FILE"
        ;;

    metrics)
        curl_json "http://localhost:${CARPI_PORT:-$DEFAULT_PORT}/api/metrics"
        ;;

    status-json)
        curl_json "http://localhost:${CARPI_PORT:-$DEFAULT_PORT}/api/status"
        ;;

    settings)
        curl_json "http://localhost:${CARPI_PORT:-$DEFAULT_PORT}/api/settings"
        ;;

    version)
        curl_json "http://localhost:${CARPI_PORT:-$DEFAULT_PORT}/api/version"
        ;;

    health)
        if [[ -x "$HOME/health_check.sh" ]]; then
            "$HOME/health_check.sh"
        elif [[ -x "$APP_DIR/health_check.sh" ]]; then
            "$APP_DIR/health_check.sh"
        else
            echo "health_check.sh not found. Expected at ~/health_check.sh or $APP_DIR/health_check.sh" >&2
            exit 1
        fi
        ;;

    open-ui)
        url="$(ui_host)"
        echo "Open this in your browser:"
        echo "  $url"
        ;;

    update)
        echo ">>> Updating CarPi in $APP_DIR"

        if [ ! -d "$APP_DIR" ]; then
            echo "Error: app directory not found: $APP_DIR" >&2
            exit 1
        fi

        cd "$APP_DIR"

        if [ -d .git ]; then
            echo ">>> git fetch --all"
            git fetch --all

            echo ">>> git pull --ff-only"
            git pull --ff-only
        else
            echo "Warning: $APP_DIR is not a git repo; skipping git pull." >&2
        fi

        if [ -x ./install.sh ]; then
            echo ">>> Running install.sh"
            ./install.sh
        else
            echo "Error: install.sh not found or not executable in $APP_DIR" >&2
            exit 1
        fi

        echo ">>> Update complete."
        ;;

    ""|-h|--help|help)
        usage
        ;;

    *)
        echo "Unknown command: $cmd" >&2
        usage
        exit 1
        ;;
esac
